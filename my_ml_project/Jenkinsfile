pipeline {
    agent any

    environment {
        VENV = 'venv'
        OUTPUT_FILE = 'output.txt'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Set Up Python') {
            steps {
                script {
                    sh 'sudo apt-get update'
                    sh 'sudo apt-get install -y python3 python3-venv'
                    sh 'python3 -m venv venv'
                }
            }
        }

        stage('Run Tests') {
            steps {
                script {
                    // Ensure pip is installed
                    sh 'sudo apt-get install -y python3-pip'

                    // Install pytest in the virtual environment
                    sh 'bash -c "source venv/bin/activate && python -m pip install pytest"'

                    // Set the working directory to the project root
                    dir('my_ml_project') {
                        // Run your tests using pytest
                        sh '. ../venv/bin/activate && python -m pytest tests'
                    }
                }
            }
        }

        stage('Run ML Script') {
            steps {
                script {
                    // Run your ML script within the virtual environment
                    sh "bash -c '. venv/bin/activate && python my_ml_project/src/my_ml_project.py > ${OUTPUT_FILE}'"
                }
            }
        }

        stage('Deployment') {
            steps {
                script {
                    // Upload the output file to a desired location
                    sh "cp ${OUTPUT_FILE} D:/LAB7/my_ml_project/${OUTPUT_FILE}"
                }
            }
        }

        stage('Deactivate Virtual Environment') {
            steps {
                script {
                    // Deactivate virtual environment after execution
                    sh ". venv/bin/deactivate || true"
                }
            }
        }
    }
}














